version: 1.0
runtime: ruby31
build:
  commands:
    pre-build:
      - yum update -y
      - yum install gcc g++ make -y
      - PYTHON=python2 amazon-linux-extras install -y postgresql9.6
      - wget https://www.sqlite.org/2020/sqlite-autoconf-3310100.tar.gz
      - tar xvfz sqlite-autoconf-3310100.tar.gz; cd sqlite-autoconf-3310100; ls; ./configure; make; make install; cd ..
      - rm -rf sqlite-autoconf-3310100
      - rm sqlite-autoconf-3310100.tar.gz
      - echo $LD_LIBRARY_PATH
      - export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH
      - export LD_RUN_PATH=/usr/local/lib:$LD_RUN_PATH
      - echo $LD_LIBRARY_PATH
    build:
      - bundle install --without devlopment test
      - ./bin/rails assets:precompile
      - ./bin/rails db:setup
run:
  env:
    - name: RAILS_ENV
      value: "production"
    - name: DATABASE_URL
      value: "arn:aws:secretsmanager:eu-west-1:214587030740:secret:EMI/PasswordPusher-kIdgs2:DATABASE_URL::"
    - name: PWP__DEFAULT_LOCALE
      value: "fr"
  network:
    port: 5100
  command: ./bin/rails server --environment=production
